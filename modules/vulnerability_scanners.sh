#!/bin/bash

if [ -z "$1" ] || [ -z "$2" ]; then
    echo "Usage: ./vulnerability_scanners.sh <subdomains_file> <output_dir>"
    exit 1
fi

# Set up variables
SUBDOMAINS_FILE=$1
OUTPUT_DIR=$2
NUCLEI_TEMPLATES="$HOME/tools/nuclei-templates"
SNIPER_REPORT="$OUTPUT_DIR/sniper_report.txt"
CONSOLIDATED_REPORT="$OUTPUT_DIR/vulnerability_scanners.txt"

# Create output directory
mkdir -p $OUTPUT_DIR

# Run vulnerability scanning on each subdomain
while read -r subdomain; do
    echo "Running vulnerability scanning on $subdomain..."
    
    # Create subdomain-specific output directory
    subdomain_output_dir="$OUTPUT_DIR/$subdomain"
    mkdir -p $subdomain_output_dir
    
    # Run Nuclei
    nuclei -update-templates -silent -t $NUCLEI_TEMPLATES -o $subdomain_output_dir/nuclei_report.txt $subdomain
    
    # Run Sn1per
    sniper --dns $subdomain --disable-web --noreport --disable-recon --exclude recon --no-colour > $subdomain_output_dir/sniper_report.txt
    
    # Consolidate subdomain results into consolidated report
    echo -e "\n\nSubdomain: $subdomain\n" >> $CONSOLIDATED_REPORT
    echo "Nuclei Report:" >> $CONSOLIDATED_REPORT
    cat $subdomain_output_dir/nuclei_report.txt >> $CONSOLIDATED_REPORT
    echo -e "\nSn1per Report:" >> $CONSOLIDATED_REPORT
    cat $subdomain_output_dir/sniper_report.txt >> $CONSOLIDATED_REPORT
    
    # Remove subdomain-specific output directory
    rm -rf $subdomain_output_dir
    
done < "$SUBDOMAINS_FILE"

# Print consolidated report
echo -e "\nConsolidated Results:"
cat $CONSOLIDATED_REPORT

echo -e "\nConsolidated report saved to: $CONSOLIDATED_REPORT"