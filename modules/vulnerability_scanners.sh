#!/bin/bash


# Set up variables
output_dir=$1
output_path="$output_dir/vulnerability_scanning"
subdomains_file="${output_dir}/subdomains.txt"
sessionMode=$2
attackSpeed=$3

#CONSOLIDATED_REPORT="$OUTPUT_DIR/consolidated_report.txt"

# Create output directory





# Run Nuclei
nuclei -update-templates -update -silent  -l $subdomains_file -o $output_path/nuclei_report.txt
    


# Run vulnerability scanning on each subdomain
while read -r subdomain; do
    echo "Running vulnerability scanning on $subdomain..."
    

    # Consolidate subdomain results into consolidated report
    #echo -e "\n\nSubdomain: $subdomain\n" >> $CONSOLIDATED_REPORT
    #echo "Nuclei Report:" >> $CONSOLIDATED_REPORT
    #cat $subdomain_output_dir/nuclei_report.txt >> $CONSOLIDATED_REPORT


    
done < "$subdomains_file"

# Print consolidated report
#echo -e "\nConsolidated Results:"
#cat $CONSOLIDATED_REPORT









niktoScanHandler() {
        if [[ $attackSpeed == "s" ]]; then
            speed="3"
        elif [[ $attackSpeed == "m" ]]; then
            speed="2"
        elif [[ $attackSpeed == "f" ]]; then
            speed="1"
        else
            speed="3"
        fi

        if [[ $sessionMode == "a" ]]; then
            nikto -h $ip --Tuning 123456789abcx -Plugins tests -c all -output $subdomain_output_dir/nikto_report.txt 2>&1
            nikto -h $ip -maxtime 60 -evasion $speed -Tuning 2 -output $subdomain_output_dir/nikto_report.txt 2>&1
        elif [[ $sessionMode == "s" ]]; then
            nikto -h $ip -ask=no -maxtime 60 -evasion 2 -Tuning 9 -Plugins @all -Format txt $speed -output $subdomain_output_dir/nikto_report.txt 2>&1
        elif [[ $sessionMode == "d" ]]; then
            nikto -h $ip -maxtime 120 -evasion $speed -output $subdomain_output_dir/nikto_report.txt 2>&1
            nikto -h $ip -maxtime 60 -maxretries 2 -evasion $speed -Tuning 2 -output $subdomain_output_dir/nikto_report.txt 2>&1
        fi
    }

    wapitiScanHandler() {
        if [[ $attackSpeed == "s" || $attackSpeed == "S" ]]; then
            speed="slow"
        elif [[ $attackSpeed == "m" || $attackSpeed == "M" ]]; then
            speed="medium"
        elif [[ $attackSpeed == "f" || $attackSpeed == "F" ]]; then
            speed="fast"
        fi

        if [[ $sessionMode == "a" || $sessionMode == "A" ]]; then
            wapiti -u http://$ip -d 5 --scope folder -f html -o $subdomain_output_dir/wapiti_report.html 2>&1
            wapiti -u http://$ip -d 5 --scope folder -f xml -o $subdomain_output_dir/wapiti_report.xml 2>&1
            wapiti -u http://$ip -d 5 --scope folder -f txt -o $subdomain_output_dir/wapiti_report.txt 2>&1
        elif [[ $sessionMode == "s" || $sessionMode == "S" ]]; then
            wapiti -u http://$ip -d 3 --scope folder -f html -o $subdomain_output_dir/wapiti_report.html 2>&1
        elif [[ $sessionMode == "d" || $sessionMode == "D" ]]; then
            wapiti -u http://$ip -d 5 --scope folder -f html -o $subdomain_output_dir/wapiti_report.html 2>&1
            wapiti -u http://$ip -d 5 --scope folder -f xml -o $subdomain_output_dir/wapiti_report.xml 2>&1
            wapiti -u http://$ip -d 5 --scope folder -f txt -o $subdomain_output_dir/wapiti_report.txt 2>&1
        fi
    }

    joomscanHandler() {
        if [[ $sessionMode == "a" ]]; then
            joomscan -a -u $target -o $subdomain_output_dir/joomscan_report.txt 2>&1
        elif [[ $sessionMode == "s" ]]; then
            joomscan -u $target -o $subdomain_output_dir/joomscan_report.txt 2>&1
        elif [[ $sessionMode == "p" ]]; then
            joomscan -p -u $target -o $subdomain_output_dir/joomscan_report.txt 2>&1
        fi
    }


niktoScanHandler
wapitiScanHandler
joomscanHandler









echo "done vulnerability_scanning"

#echo -e "\nConsolidated report saved to: $CONSOLIDATED_REPORT"